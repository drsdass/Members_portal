<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - {{ session['username'] }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom styles for tables */
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* gray-200 */
        }
        th {
            background-color: #f8fafc; /* gray-50 */
            font-weight: 600; /* semi-bold */
            color: #4a5568; /* gray-700 */
            text-transform: uppercase;
            font-size: 0.875rem; /* text-sm */
        }
        tr:hover {
            background-color: #f0f4f8; /* blue-50 */
        }
        .btn {
            @apply px-4 py-2 rounded-md font-medium text-sm;
        }
        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500;
        }
        .btn-secondary {
            @apply bg-gray-300 text-gray-800 hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex">

    <!-- Sidebar -->
    <aside class="w-64 bg-white shadow-md p-6 flex flex-col justify-between">
        <div>
            <h3 class="text-xl font-bold text-gray-800 mb-6 border-b pb-4">Report Options</h3>
            <form action="/select_report" method="post" class="space-y-4">
                <div>
                    <label for="report_type" class="block text-sm font-medium text-gray-700 mb-1">Report Type:</label>
                    <select id="report_type" name="report_type" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        {% for type in available_report_types %}
                            <option value="{{ type.value }}" {% if type.value == report_type %}selected{% endif %}>{{ type.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="entity_name" class="block text-sm font-medium text-gray-700 mb-1">Entity:</label>
                    <select id="entity_name" name="entity_name" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="">-- Select Entity --</option>
                        {% for entity in master_entities %}
                            <option value="{{ entity }}" {% if entity == selected_entity %}selected{% endif %}>{{ entity }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Month and Year selection only for Monthly Bonus Reports and Financial Reports -->
                <div id="month-year-selection" class="space-y-4">
                    <div>
                        <label for="month" class="block text-sm font-medium text-gray-700 mb-1">Month:</label>
                        <select id="month" name="month"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">All Months</option>
                            {% for month_data in months %}
                                <option value="{{ month_data.value }}" {% if month_data.value == selected_month %}selected{% endif %}>{{ month_data.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="year" class="block text-sm font-medium text-gray-700 mb-1">Year:</label>
                        <select id="year" name="year"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">All Years</option>
                            {% for year_val in years %}
                                <option value="{{ year_val }}" {% if year_val == selected_year|int %}selected{% endif %}>{{ year_val }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <button type="submit" class="w-full btn btn-primary">
                    Apply Filters
                </button>
            </form>
        </div>

        <div class="mt-6 text-center">
            <a href="/logout" class="text-blue-600 hover:underline">Logout</a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8">
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900">Dashboard</h1>
            <div class="text-right">
                <p class="text-lg text-gray-700">Logged in as: <span class="font-semibold">{{ current_username }}</span></p>
                <p class="text-md text-gray-600">Viewing: <span class="font-medium">{{ report_type | replace('_', ' ') | title }}</span> for <span class="font-medium">{{ selected_entity }}</span></p>
                {% if selected_month %}
                    <p class="text-md text-gray-600">Month: <span class="font-medium">{{ selected_month }}</span></p>
                {% endif %}
                {% if selected_year %}
                    <p class="text-md text-gray-600">Year: <span class="font-medium">{{ selected_year }}</span></p>
                {% endif %}
            </div>
        </header>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6 space-y-3">
                    {% for category, message in messages %}
                        <p class="{% if category == 'error' %}bg-red-100 border border-red-400 text-red-700{% elif category == 'success' %}bg-green-100 border border-green-400 text-green-700{% else %}bg-blue-100 border border-blue-400 text-blue-700{% endif %} px-4 py-3 rounded-md text-center">
                            {{ message }}
                        </p>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <section class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Report Details</h2>

            {% if report_type == 'patient_reports' %}
                <p class="text-gray-700">This section is for patient-specific reports. Please use the "Patient Reports" section or log in as a patient to view individual lab results.</p>
            {% elif files %}
                <h4 class="text-lg font-semibold text-gray-700 mb-3">Available Report Files:</h4>
                <ul class="space-y-3">
                    {% for file in files %}
                        <li class="flex items-center justify-between bg-gray-50 p-3 rounded-md shadow-sm">
                            <span class="text-gray-800 font-medium">{{ file.name }}</span>
                            <a href="{{ url_for('static', filename=file.filename) }}" target="_blank" class="btn btn-primary btn-sm">View PDF</a>
                        </li>
                    {% endfor %}
                </ul>
            {% elif data %}
                <h4 class="text-lg font-semibold text-gray-700 mb-3">Report Data Preview:</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                        <thead>
                            <tr>
                                {% for key in data[0].keys() %}
                                    <th>{{ key | replace('_', ' ') | title }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data %}
                                <tr>
                                    {% for value in row.values() %}
                                        <td>{{ value }}</td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p class="text-gray-700">No reports found for your current selection criteria. Please try selecting a different month, year, or report type.</p>
            {% endif %}
        </section>
    </main>

    <script>
        // JavaScript to show/hide month and year selection based on report type
        document.addEventListener('DOMContentLoaded', function() {
            const reportTypeSelect = document.getElementById('report_type');
            const monthYearSelection = document.getElementById('month-year-selection');

            function toggleMonthYearVisibility() {
                const selectedReportType = reportTypeSelect.value;
                if (selectedReportType === 'monthly_bonus_reports' || selectedReportType === 'financial_reports' || selectedReportType === 'requisition_reports') {
                    monthYearSelection.style.display = 'block';
                } else {
                    monthYearSelection.style.display = 'none';
                }
            }

            // Set initial visibility
            toggleMonthYearVisibility();

            // Add event listener for changes
            reportTypeSelect.addEventListener('change', toggleMonthYearVisibility);
        });
    </script>
</body>
</html>
